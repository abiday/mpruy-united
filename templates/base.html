{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block meta %} {% endblock meta %}
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="{% static 'css/global.css' %}"/>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
    body {
        font-family: 'Montserrat', sans-serif;
    }
    </style>

  </head>
  <body>
    {% block content %}
    {% include 'modal.html' %}

    <script>
        const AUTH_URLS = {
            login: "{% url 'main:login_ajax' %}",
            register: "{% url 'main:register_ajax' %}",
            logout: "{% url 'main:logout_ajax' %}"
        };

        function showAuthError(formId, message) {
            const errorDiv = document.getElementById(`${formId}Error`);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideAuthError(formId) {
            const errorDiv = document.getElementById(`${formId}Error`);
            errorDiv.classList.add('hidden');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError('login');
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch(AUTH_URLS.login, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('loginModal').classList.add('hidden');
                    showToast('Login successful!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAuthError('login', data.message);
                    showToast(data.message || 'Login failed', 'error');
                }
            } catch (error) {
                showAuthError('login', 'An error occurred. Please try again.');
                showToast('An error occurred. Please try again.', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            hideAuthError('register');
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch(AUTH_URLS.register, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    document.getElementById('registerModal').classList.add('hidden');
                    showToast('Registration successful!', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    showAuthError('register', data.message);
                    showToast(data.message || 'Registration failed', 'error');
                }
            } catch (error) {
                showAuthError('register', 'An error occurred. Please try again.');
                showToast('An error occurred. Please try again.', 'error');
            }
        });

        async function handleLogout() {
            try {
                const response = await fetch(AUTH_URLS.logout, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    showToast('Logout successful!', 'success');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                }
            } catch (error) {
                console.error('Logout failed:', error);
            }
        }

        document.querySelector('[data-action="logout"]')?.addEventListener('click', handleLogout);

        function showLoginModal() {
            document.getElementById('loginModal').classList.remove('hidden');
        }

        function showRegisterModal() {
            document.getElementById('registerModal').classList.remove('hidden');
        }
    </script>
    {% endblock content %}
    {% include 'toast.html' %}
  </body>
</html>