{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Football Shop</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<!-- Hero Section -->
<section class="relative w-full h-screen flex items-center justify-center">
  <div class="absolute inset-0">
    <img src="{% static 'image/signin-bg.png' %}" alt="Football Hero" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
  </div>
  <div class="relative z-10 text-center">
    <h1 class="text-6xl md:text-8xl font-extrabold text-white mb-6">KITS</h1>
    <a href="#products" class="inline-block bg-yellow-400 text-black font-bold px-8 py-3 rounded-md shadow hover:bg-yellow-500 transition">
      SHOP NOW â†’
    </a>
  </div>
</section>

<!-- Products Section -->
<section id="products" class="w-full min-h-screen pt-20 pb-12" style="background-color: #14193a;">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-12">
      <h2 class="text-4xl font-extrabold text-white mb-3">Our Kits</h2>
      <p class="text-gray-300">Choose your favorite football gear and join the squad</p>
    </div>

    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-white rounded-lg border border-gray-200 p-4">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button id="filter-all" class="px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white bg-red-600 text-white">
          All Products
        </button>
        {% if user.is_authenticated %}
        <button id="filter-my" class="px-4 py-2 rounded-md font-medium transition-colors hover:bg-blue-600 hover:text-white bg-white text-gray-700 border border-gray-300">
          My Products
        </button>
        {% endif %}
      </div>
      {% if user.is_authenticated %}
        <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-red-600 to-blue-700 text-white rounded-md hover:from-red-700 hover:to-blue-800 transition-colors">
          + Add New Product
        </button>
      {% endif %}
    </div>

    <div id="loading" class="hidden text-center py-12">
      <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-white"></div>
    </div>

    <div id="products-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div id="empty-state" class="hidden bg-white rounded-lg border border-gray-200 p-12 text-center">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No products available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-gray-900 mb-2">No products found</h3>
      <p class="text-gray-500 mb-6">Be the first to add football products to the shop.</p>
      {% if user.is_authenticated %}
        <button onclick="openCreateModal()" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-red-600 to-blue-700 text-white rounded-md hover:from-red-700 hover:to-blue-800 transition">
          Add Product
        </button>
      {% endif %}
    </div>
  </div>
</section>

<!-- Product Modal -->
<div id="productModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="relative w-full max-w-2xl bg-gradient-to-br from-red-800 to-blue-900 rounded-xl shadow-xl">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 id="modalTitle" class="text-xl font-semibold text-yellow-400">Add New Product</h3>
        <button onclick="hideModal()" class="text-gray-400 hover:text-white">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <form id="productForm" class="p-4" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" id="productId" name="productId">
        <div class="space-y-4">
          <div>
            <label for="name" class="block text-sm font-medium text-yellow-300">Name</label>
            <input type="text" id="name" name="name" required class="mt-1 block w-full rounded-md bg-white/10 border border-gray-600 text-white shadow-sm focus:border-yellow-400 focus:ring-yellow-400 px-3 py-2">
          </div>
          <div>
            <label for="price" class="block text-sm font-medium text-yellow-300">Price</label>
            <input type="number" id="price" name="price" required class="mt-1 block w-full rounded-md bg-white/10 border border-gray-600 text-white shadow-sm focus:border-yellow-400 focus:ring-yellow-400 px-3 py-2">
          </div>
          <div>
            <label for="description" class="block text-sm font-medium text-yellow-300">Description</label>
            <textarea id="description" name="description" rows="3" required class="mt-1 block w-full rounded-md bg-white/10 border border-gray-600 text-white shadow-sm focus:border-yellow-400 focus:ring-yellow-400 px-3 py-2"></textarea>
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-yellow-300">Category</label>
            <select id="category" name="category" required class="mt-1 block w-full rounded-md bg-white/10 border border-gray-600 text-white shadow-sm focus:border-yellow-400 focus:ring-yellow-400 px-3 py-2">
              <option value="Jersey">Jersey</option>
              <option value="Boots">Boots</option>
              <option value="Equipment">Equipment</option>
            </select>
          </div>
          <div>
            <label for="image" class="block text-sm font-medium text-yellow-300">Main Image</label>
            <input type="file" id="image" name="image" class="mt-1 block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-yellow-400 file:text-black hover:file:bg-yellow-500">
          </div>
          <div>
            <label for="second_image" class="block text-sm font-medium text-yellow-300">Second Image</label>
            <input type="file" id="second_image" name="second_image" class="mt-1 block w-full text-sm text-gray-300 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-yellow-400 file:text-black hover:file:bg-yellow-500">
          </div>
        </div>
        <div class="mt-6 flex justify-end space-x-3">
          <button type="button" onclick="hideModal()" class="px-4 py-2 rounded-md text-gray-300 hover:text-white bg-gray-700 hover:bg-gray-600 transition-colors">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-md text-white bg-gradient-to-r from-red-600 to-blue-600 hover:from-red-700 hover:to-blue-700 transition-colors">Save Product</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
  <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
  <div class="flex min-h-full items-center justify-center p-4">
    <div class="relative w-full max-w-md bg-gradient-to-br from-red-800 to-blue-900 rounded-xl shadow-xl">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 class="text-xl font-semibold text-yellow-400">Confirm Deletion</h3>
        <button onclick="hideDeleteModal()" class="text-gray-400 hover:text-white">
          <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="p-6">
        <p class="text-white text-center">Are you sure you want to delete this product?</p>
        <div class="mt-6 flex justify-center space-x-3">
          <button onclick="hideDeleteModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 transition-colors">Cancel</button>
          <button onclick="confirmDelete()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Yes, Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

<script>
const CURRENT_USER_ID = "{{ user.id|default:'null' }}";
const PRODUCTS_API = "{% url 'main:get_products_json' %}";
const CREATE_API = "{% url 'main:create_product_ajax' %}";
const UPDATE_API = "{% url 'main:update_product_ajax' 0 %}".slice(0, -1);

let allProducts = [];
let currentFilter = 'all';

function displayPageSection({ showLoading = false, showGrid = false, showEmpty = false }) {
  document.getElementById('loading').classList.toggle('hidden', !showLoading);
  document.getElementById('products-grid').classList.toggle('hidden', !showGrid);
  document.getElementById('empty-state').classList.toggle('hidden', !showEmpty);
}

function updateFilterButtons() {
  document.querySelectorAll('#filter-all, #filter-my').forEach(btn => {
    btn.classList.remove('bg-red-600', 'text-white');
    btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-gray-300');
  });
  const activeBtn = document.getElementById(`filter-${currentFilter}`);
  if (activeBtn) {
    activeBtn.classList.remove('bg-white', 'text-gray-700', 'border', 'border-gray-300');
    activeBtn.classList.add('bg-red-600', 'text-white');
  }
}

async function fetchProducts() {
  displayPageSection({ showLoading: true });
  try {
    const response = await fetch(PRODUCTS_API);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const contentType = response.headers.get("content-type");
    if (!contentType || !contentType.includes("application/json")) throw new TypeError("Response was not JSON");
    allProducts = await response.json();
    filterAndRenderProducts();
  } catch (error) {
    console.error('Error:', error);
    displayPageSection({ showEmpty: true });
    showToast('Failed to load products', 'error');
  }
}

function filterAndRenderProducts() {
  let filteredProducts = allProducts;
  if (currentFilter === 'my' && CURRENT_USER_ID && CURRENT_USER_ID !== 'null') {
    filteredProducts = allProducts.filter(product => String(product.user_id) === String(CURRENT_USER_ID));
  }
  renderProducts(filteredProducts);
  displayPageSection({ showGrid: filteredProducts.length > 0, showEmpty: filteredProducts.length === 0 });
}

function renderProducts(products) {
  const grid = document.getElementById('products-grid');
  grid.innerHTML = products.map(product => `
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
      <img src="${product.image_url}" alt="${product.name}" class="w-full h-48 object-cover">
      <div class="p-4">
        <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
        <p class="text-gray-600 mb-2">${product.description}</p>
        <p class="text-xl font-bold text-red-600">$${product.price}</p>
        ${String(CURRENT_USER_ID) === String(product.user_id) ? `
          <div class="flex space-x-2 mt-4">
            <button onclick="editProduct(${product.id})" class="px-4 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 transition">Edit</button>
            <button onclick="showDeleteModal(${product.id})" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">Delete</button>
          </div>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function openCreateModal() {
  document.getElementById('modalTitle').textContent = 'Add New Product';
  document.getElementById('productForm').reset();
  document.getElementById('productId').value = '';
  document.getElementById('productModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideModal() {
  document.getElementById('productModal').classList.add('hidden');
  document.body.style.overflow = '';
}

async function editProduct(productId) {
  const product = allProducts.find(p => p.id === productId);
  if (!product) return;
  document.getElementById('modalTitle').textContent = 'Edit Product';
  document.getElementById('productId').value = product.id;
  document.getElementById('name').value = product.name;
  document.getElementById('price').value = product.price;
  document.getElementById('description').value = product.description;
  document.getElementById('category').value = product.category;
  document.getElementById('productModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function showDeleteModal(productId) {
  window.productIdToDelete = productId;
  document.getElementById('deleteConfirmModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function hideDeleteModal() {
  document.getElementById('deleteConfirmModal').classList.add('hidden');
  document.body.style.overflow = '';
  window.productIdToDelete = null;
}

async function confirmDelete() {
  if (!window.productIdToDelete) return;
  try {
    const response = await fetch(`/ajax/delete-product/${window.productIdToDelete}/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value }
    });
    const data = await response.json();
    if (data.status === 'success') {
      hideDeleteModal();
      await fetchProducts();
      showToast('Product deleted successfully');
    } else {
      throw new Error(data.message || 'Failed to delete product');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast('Failed to delete product', 'error');
  }
}

async function handleProductForm(event) {
  event.preventDefault();
  const form = event.target;
  const submitBtn = form.querySelector('button[type="submit"]');
  const originalText = submitBtn.textContent;
  try {
    submitBtn.disabled = true;
    submitBtn.textContent = 'Saving...';
    const formData = new FormData(form);
    const productId = document.getElementById('productId').value;
    const url = productId ? `${UPDATE_API}${productId}/` : CREATE_API;
    const response = await fetch(url, { method: 'POST', body: formData });
    const data = await response.json();
    if (data.status === 'success') {
      hideModal();
      await fetchProducts();
      showToast(data.message);
    } else {
      throw new Error(data.message || 'Failed to save product');
    }
  } catch (error) {
    console.error('Error:', error);
    showToast(error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.textContent = originalText;
  }
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `transform transition-all duration-300 ease-out scale-95 opacity-0 mb-4 p-4 rounded-lg shadow-lg max-w-sm ${type === 'success' ? 'bg-gradient-to-r from-green-600 to-green-700 text-white' : 'bg-gradient-to-r from-red-600 to-red-700 text-white'}`;
  toast.innerHTML = `
    <div class="flex items-center">
      <div class="flex-shrink-0">
        ${type === 'success' ? '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : '<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'}
      </div>
      <div class="ml-3"><p class="text-sm font-medium">${message}</p></div>
    </div>`;
  const container = document.getElementById('toast-container');
  container.appendChild(toast);
  setTimeout(() => {
    toast.classList.remove('scale-95', 'opacity-0');
    toast.classList.add('scale-100', 'opacity-100');
  }, 10);
  setTimeout(() => {
    toast.classList.add('scale-95', 'opacity-0');
    setTimeout(() => container.removeChild(toast), 300);
  }, 3000);
}

document.addEventListener('DOMContentLoaded', () => {
  fetchProducts();
  document.getElementById('filter-all').addEventListener('click', () => {
    currentFilter = 'all';
    updateFilterButtons();
    filterAndRenderProducts();
  });
  document.getElementById('filter-my')?.addEventListener('click', () => {
    currentFilter = 'my';
    updateFilterButtons();
    filterAndRenderProducts();
  });
  document.getElementById('productForm').addEventListener('submit', handleProductForm);
});

document.querySelectorAll('a[href^="#"]').forEach(anchor => {
  anchor.addEventListener("click", function(e) {
    e.preventDefault();
    document.querySelector(this.getAttribute("href")).scrollIntoView({ behavior: "smooth" });
  });
});
</script>
{% endblock content %}